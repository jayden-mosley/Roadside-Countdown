<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EFM Roadside Welfare Timer</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg-color);
      color: white;
      overflow-x: hidden;
    }

    :root {
      --bg-color: #000;
    }

    .tab {
      display: none;
    }

    .tab.active {
      display: block;
    }

    .tabs {
      display: flex;
      flex-wrap: wrap;
    }

    .tabs button {
      background: #333;
      color: white;
      border: none;
      padding: 10px;
      cursor: pointer;
    }

    .tabs button.active {
      background: #555;
    }

    .bird {
      position: absolute;
      width: 60px;
      height: auto;
      animation: fly 15s linear forwards;
      z-index: 5;
    }

    @keyframes fly {
      from {
        left: -100px;
      }
      to {
        left: 100vw;
      }
    }

    .stars {
      position: fixed;
      width: 100%;
      height: 100%;
      background: transparent;
      overflow: hidden;
      z-index: -1;
    }

    .star {
      position: absolute;
      width: 2px;
      height: 2px;
      background: white;
      animation: twinkle 2s infinite ease-in-out;
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.2; }
      50% { opacity: 1; }
    }

    .shooting-star {
      position: absolute;
      width: 100px;
      height: 2px;
      background: white;
      opacity: 0;
      transform: rotate(45deg);
      animation: shoot 1s ease-in-out;
    }

    @keyframes shoot {
      0% {
        top: -50px;
        left: -50px;
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      100% {
        top: 100vh;
        left: 100vw;
        opacity: 0;
      }
    }
  </style>
</head>
<body>
  <div class="stars" id="starfield"></div>

  <div class="tabs" id="tabs"></div>
  <div id="tab-content"></div>

  <script>
    const vehicles = {};

    function createVehicleTab(reg) {
      if (vehicles[reg]) return;

      vehicles[reg] = {
        countdownStart: null,
        countdownEnded: false,
        recoveryStart: null,
        inRecovery: false
      };

      const tabButton = document.createElement('button');
      tabButton.textContent = reg;
      tabButton.onclick = () => activateTab(reg);
      tabButton.id = `tab-btn-${reg}`;
      document.getElementById('tabs').appendChild(tabButton);

      const tabDiv = document.createElement('div');
      tabDiv.classList.add('tab');
      tabDiv.id = `tab-${reg}`;
      tabDiv.innerHTML = `
        <h2>${reg}</h2>
        <div>Status: <span id="status-${reg}">Awaiting Recovery</span></div>
        <div>Countdown: <span id="countdown-${reg}">30:00</span></div>
        <button onclick="resetCountdown('${reg}')">Reset Countdown</button>
        <div id="recovery-${reg}">Recovery Time: 0:00</div>
        <button onclick="startRecovery('${reg}')">Start Recovery</button>
        <button onclick="stopRecovery('${reg}')">Stop Recovery</button>
      `;
      document.getElementById('tab-content').appendChild(tabDiv);

      activateTab(reg);
      resetCountdown(reg);
    }

    function activateTab(reg) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab-${reg}`).classList.add('active');
      document.getElementById(`tab-btn-${reg}`).classList.add('active');
    }

    function resetCountdown(reg) {
      vehicles[reg].countdownStart = Date.now();
      vehicles[reg].countdownEnded = false;
    }

    function startRecovery(reg) {
      vehicles[reg].recoveryStart = Date.now();
      vehicles[reg].inRecovery = true;
      document.getElementById(`status-${reg}`).innerText = "In Recovery";
    }

    function stopRecovery(reg) {
      vehicles[reg].inRecovery = false;
      document.getElementById(`status-${reg}`).innerText = "Recovered";
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    function updateDisplay() {
      Object.keys(vehicles).forEach(reg => {
        const v = vehicles[reg];

        if (v.countdownStart) {
          const elapsed = Math.floor((Date.now() - v.countdownStart) / 1000);
          const remaining = Math.max(0, 1800 - elapsed);
          document.getElementById(`countdown-${reg}`).innerText = formatTime(remaining);

          if (remaining === 0 && !v.countdownEnded) {
            v.countdownEnded = true;
            new Notification(`${reg} has reached 30 minutes!`);
            const sound = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_d62cf51db4.mp3?filename=twinkle-113735.mp3');
            sound.play();
          }
        }

        if (v.inRecovery && v.recoveryStart) {
          const elapsed = Math.floor((Date.now() - v.recoveryStart) / 1000);
          document.getElementById(`recovery-${reg}`).innerText = `Recovery Time: ${formatTime(elapsed)}`;
        }
      });

      requestAnimationFrame(updateDisplay);
    }

    updateDisplay();

    if (Notification.permission !== "granted") {
      Notification.requestPermission();
    }

    // Dynamic styling for day/night
    const now = new Date();
    const hour = now.getHours();
    const root = document.documentElement;

    const starfield = document.getElementById('starfield');

    if (hour >= 17 || hour < 6) {
      root.style.setProperty('--bg-color', '#000');
      for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.classList.add('star');
        star.style.top = `${Math.random() * 100}vh`;
        star.style.left = `${Math.random() * 100}vw`;
        starfield.appendChild(star);
      }

      setInterval(() => {
        const shootingStar = document.createElement('div');
        shootingStar.classList.add('shooting-star');
        shootingStar.style.top = `${Math.random() * 50}vh`;
        shootingStar.style.left = `${Math.random() * 50}vw`;
        starfield.appendChild(shootingStar);
        setTimeout(() => shootingStar.remove(), 1000);
      }, 10000);

    } else {
      root.style.setProperty('--bg-color', '#87ceeb'); // light sky
      spawnBirdsRandomly();
    }

    function spawnBirdsRandomly() {
      const birdImg = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAAaCAYAAABTKNU8AAAACXBIWXMAAAsTAAALEwEAmpwYAAABJklEQVRoge3WwQ2CQBAE0cvYgAEdZyF4nIGQkzAzdFYGiZSzIAf0c3qzvv10CgI5uUkkkklmyTsHDhw4cOHChQsWLFiwYMGCBQsWLFiw4H8Kea5mFbcCaA3CuA9YJwF0KcBfCnAXgqgPWCcBdCnAXwpgNwvAOgfQpgNwnAHQpgF4KsBeCnAXQpgF4KsBeCnAXQpgNwrAHQpwF8KYDcKwD0KYAeCnAXgqgNwpwF8KYAeCnAXQpgN4KsBeCnAXQpwF4KsBeCnAXQpwF4KsBeCnAXQpwF4K8PqWwD8m8Q9xXbLM1wAAAABJRU5ErkJggg==';

      function spawnBird() {
        const bird = document.createElement('img');
        bird.src = birdImg;
        bird.classList.add('bird');
        bird.style.top = `${Math.random() * 60 + 10}vh`;
        bird.style.animationDuration = `${10 + Math.random() * 10}s`;
        document.body.appendChild(bird);
        bird.addEventListener('animationend', () => bird.remove());

        const nextSpawn = Math.random() * 10000 + 5000;
        setTimeout(spawnBird, nextSpawn);
      }

      spawnBird();
    }

    // Init test vehicles
    createVehicleTab("EFM-001");
    createVehicleTab("EFM-002");
  </script>
</body>
</html>
